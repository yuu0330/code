<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”°é–“ç›£æ¸¬</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body data-page="results">

    <!-- å°è¦½åˆ— -->
    <div class="navbar">
        <h1>ç—…èŸ²å®³åµæ¸¬åŠè­¦ç¤ºæ•´åˆç³»çµ±</h1>
        <nav>
            <a href="/">ç™»å‡º</a>
    
            <div class="dropdown">
                <button class="dropbtn">å®³èŸ²æ¨¡çµ„ â–¼</button>
                <div class="dropdown-content">
                    <a href="/degree">å®³èŸ²ç›£æ¸¬</a>
                    <a href="/degree_history">æ­·å²è³‡æ–™</a>
                </div>
            </div>
    
            <div class="dropdown">
                <button class="dropbtn">å ´åŸŸè³‡æ–™ â–¼</button>
                <div class="dropdown-content">
                    <a href="/results">ç’°å¢ƒç›£æ¸¬</a>
                    <a href="/results_history">æ­·å²è³‡æ–™</a>
                </div>
            </div>
    
            <div class="dropdown">
                <button class="dropbtn">è³‡æç®¡ç† â–¼</button>
                <div class="dropdown-content">
                    <a href="/material">è³‡æç´€éŒ„</a>
                    <a href="/material_history">æ­·å²è³‡æ–™</a>
                </div>
            </div>
        </nav>
    </div>
    <div class="content">
        <h2 class="page-title">å ´åŸŸç’°å¢ƒç›£æ¸¬</h2>

        <!-- ä¸Šæ’ï¼šç’°å¢ƒæ•¸æ“š -->
        <div class="gauge-container">
            <div class="gauge-box" id="gaugeEnvTemp"></div>
            <div class="gauge-box" id="gaugeEnvHumidity"></div>
        </div>

        <!-- ä¸‹æ’ï¼šåœŸå£¤æ•¸æ“š -->
        <div class="gauge-container">
            <div class="gauge-box" id="gaugeSoilTemp"></div>
            <div class="gauge-box" id="gaugeSoilMoisture"></div>
            <div class="gauge-box" id="gaugeSoilEC"></div>
        </div>
    </div>

    <script>
        function createGauge(value, title, range, colors) {
            return {
                type: "indicator",
                mode: "gauge+number",
                value: value,
                title: { 
                    text: `<span class="title-text">${title}</span>`, 
                    font: { size: 24 },
                    y: 1.2
                },
                number: { 
                    font: { size: 40 }, 
                    yanchor: "bottom",
                    font: { size: 40, weight: "bold" } // ğŸ›  è®“é¡¯ç¤ºæ•¸å­—è®Šå¤§
                },
                gauge: {
                    shape: "semi-circle",
                    axis: { range: range, tickwidth: 1, tickcolor: "black", tickfont: { size: 12 } }, // ğŸ›  åˆ»åº¦å­—é«”ç¸®å°
                    bar: { color: "darkblue", thickness: 0.3 },
                    steps: colors.map(c => ({ range: [c[0], c[1]], color: c[2] })),
                    threshold: {
                        line: { color: "darkblue", width: 5 },
                        thickness: 0.8,
                        value: value
                    }
                }
            };
        }
        async function fetchWeatherData() {
            try {
                let response = await fetch(
                    "https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-D0047-035?Authorization=CWA-233147B7-C268-43C1-BC20-C819EE149C00&format=JSON&LocationName=å…§åŸ”é„‰&ElementName=å¹³å‡æº«åº¦,å¹³å‡ç›¸å°æ¿•åº¦"
                );

                let data = await response.json();
                console.log("âœ… API åŸå§‹å›æ‡‰:", JSON.stringify(data, null, 2)); // ğŸ›  æª¢æŸ¥å®Œæ•´ API å›æ‡‰

                // ğŸ›  ç¢ºä¿ `records` å­˜åœ¨
                if (!data.records || !data.records.Locations) {
                    throw new Error("âŒ API å›æ‡‰æ²’æœ‰ records æˆ– Locations");
                }

                // ğŸ›  è§£æ `Locations`
                let locations = data.records.Locations;
                let locationData = locations[0].Location.find(loc => loc.LocationName === "å…§åŸ”é„‰");

                if (!locationData) {
                    throw new Error("âŒ æ‰¾ä¸åˆ°å…§åŸ”é„‰çš„æ•¸æ“š");
                }

                let elements = locationData.WeatherElement;
                if (!elements || elements.length < 2) {
                    throw new Error("âŒ æ‰¾ä¸åˆ° weatherElement");
                }

                let tempElement = elements.find(e => e.ElementName === "å¹³å‡æº«åº¦");
                let humidityElement = elements.find(e => e.ElementName === "å¹³å‡ç›¸å°æ¿•åº¦");

                if (!tempElement || !humidityElement) {
                    throw new Error("âŒ ç¼ºå°‘å¹³å‡æº«åº¦æˆ–å¹³å‡ç›¸å°æ¿•åº¦çš„æ•¸æ“š");
                }

                let temp = tempElement.Time[0].ElementValue[0].Temperature;
                let humidity = humidityElement.Time[0].ElementValue[0].RelativeHumidity;

                return { temperature: parseFloat(temp), humidity: parseFloat(humidity) };

            } catch (error) {
                console.error("âŒ API è®€å–å¤±æ•—:", error);
                return { temperature: 25, humidity: 60 }; // ğŸ›  é è¨­æ•¸æ“šï¼Œé¿å… UI å´©æ½°
            }
        }

        function generateSoilData(envTemperature) {
            return {
                soilTemperature: (envTemperature - (Math.random() * 1 + 1)).toFixed(1),
                soilMoisture: (Math.random()).toFixed(2),
                soilEC: (Math.random() * (4 - 1) + 1).toFixed(2)
            };
        }

        // ç¢ºä¿ä¸‹æ‹‰é¸å–®å¯ä»¥å±•é–‹
        $(document).ready(function () {
            $(".dropbtn").click(function () {
                $(".dropdown-content").not($(this).next()).slideUp(200);
                $(this).next(".dropdown-content").slideToggle(200);
            });

            $(document).click(function (event) {
                if (!$(event.target).closest(".dropdown").length) {
                    $(".dropdown-content").slideUp(200);
                }
            });
        });
        
        async function updateGauges() {
            let data = await fetchWeatherData();
            let soilData = generateSoilData(data.temperature);

            Plotly.newPlot('gaugeEnvTemp', [createGauge(data.temperature, "ç’°å¢ƒæº«åº¦ (Â°C)", [0, 50], [
                [0, 10, "#4CAF50"], [10, 20, "#00BCD4"], [20, 30, "#FFC107"], [30, 50, "#F44336"]
            ])]);

            Plotly.newPlot('gaugeEnvHumidity', [createGauge(data.humidity, "ç’°å¢ƒæ¿•åº¦ (%)", [0, 100], [
                [0, 25, "#4CAF50"], [25, 50, "#00BCD4"], [50, 75, "#FFC107"], [75, 100, "#F44336"]
            ])]);

            Plotly.newPlot('gaugeSoilTemp', [createGauge(soilData.soilTemperature, "åœŸå£¤æº«åº¦ (Â°C)", [0, 50], [
                [0, 10, "#4CAF50"], [10, 20, "#00BCD4"], [20, 30, "#FFC107"], [30, 50, "#F44336"]
            ])]);

            Plotly.newPlot('gaugeSoilMoisture', [createGauge(soilData.soilMoisture, "åœŸå£¤å«æ°´é‡ (%)", [0, 1], [
                [0, 0.2, "#4CAF50"], [0.2, 0.4, "#00BCD4"], [0.4, 0.7, "#FFC107"], [0.7, 1, "#F44336"]
            ])]);

            Plotly.newPlot('gaugeSoilEC', [createGauge(soilData.soilEC, "åœŸå£¤ECå€¼ (mmhos/cm)", [1, 4], [
                [1, 2, "#4CAF50"], [2, 3, "#FFC107"], [3, 4, "#F44336"]
            ])]);
        }

        updateGauges();
        setInterval(updateGauges, 30000);
    </script>

</body>
</html>
